<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Input Transaksi Barang Masuk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <h2 class="mb-4">ðŸ“¥ Input Transaksi Barang Masuk</h2>
            <a href="/merchAdmin.html" class="btn btn-gradient">Kembali</a>
        </div>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Data Transaksi Utama</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tanggal Masuk</label>
                        <input type="date" id="transactionDate" class="form-control" value="2025-12-17">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Supplier</label>
                        <select id="supplierSelect" class="form-select">
                            <option value="1">Supplier A</option>
                            <option value="2">Supplier B</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Detail Barang Masuk</h5>
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Produk</label>
                        <select id="productSelect" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Jumlah Masuk</label>
                        <input type="number" id="qtyInput" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Harga Beli</label>
                        <input type="number" id="priceInput" class="form-control" value="0">
                    </div>
                    <div class="col-md-2">
                        <button type="button" onclick="addItem()" class="btn btn-secondary w-100">Tambah</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>PRODUK (ID)</th>
                            <th>JUMLAH MASUK</th>
                            <th>HARGA BELI</th>
                            <th>SUBTOTAL</th>
                            <th>AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="itemListTable"></tbody>
                    <tfoot>
                        <tr class="fw-bold">
                            <td colspan="3" class="text-end">TOTAL BELANJA</td>
                            <td colspan="2">Rp <span id="grandTotal">0</span></td>
                        </tr>
                    </tfoot>
                </table>
                <button onclick="saveTransaction()" class="btn btn-success w-100 mt-3">SIMPAN TRANSAKSI MASUK</button>
            </div>
        </div>
    </div>

    <script>
        let itemsToSave = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Load Produk
            const res = await fetch('/api/merch/products');
            const result = await res.json();
            const select = document.getElementById('productSelect');
            select.innerHTML = result.data.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name} (Stok: ${p.stock})</option>`).join('');
        });

        function addItem() {
            const select = document.getElementById('productSelect');
            const id = select.value;
            const name = select.options[select.selectedIndex].dataset.name;
            const qty = parseInt(document.getElementById('qtyInput').value);
            const price = parseInt(document.getElementById('priceInput').value);

            itemsToSave.push({ product_id: id, name, quantity: qty, buy_price: price });
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('itemListTable');
            let total = 0;
            tbody.innerHTML = itemsToSave.map((item, index) => {
                const subtotal = item.quantity * item.buy_price;
                total += subtotal;
                return `
                    <tr>
                        <td>${item.name} (${item.product_id})</td>
                        <td>${item.quantity}</td>
                        <td>Rp ${item.buy_price.toLocaleString('id-ID')}</td>
                        <td>Rp ${subtotal.toLocaleString('id-ID')}</td>
                        <td><button onclick="removeItem(${index})" class="btn btn-danger btn-sm">Hapus</button></td>
                    </tr>
                `;
            }).join('');
            document.getElementById('grandTotal').innerText = total.toLocaleString('id-ID');
        }

        function removeItem(index) {
            itemsToSave.splice(index, 1);
            renderTable();
        }

        async function saveTransaction() {
            if (itemsToSave.length === 0) return alert('Daftar barang masih kosong!');
            
            const payload = {
                transaction_date: document.getElementById('transactionDate').value,
                supplier_id: document.getElementById('supplierSelect').value,
                items: itemsToSave
            };

            const response = await fetch('/api/merch/inventory-in', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert('âœ… Berhasil Simpan Transaksi!');
                window.location.href = '/merchAdmin.html';
            }
        }
    </script>
</body>
</html>