<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Pergerakan Stok - Inventaris</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css" />
    <style>
        .table-header-custom { background-color: #f8f9fa; font-weight: bold; text-align: center; vertical-align: middle; }
        .text-masuk { color: #28a745; font-weight: bold; }
        .text-keluar { color: #dc3545; font-weight: bold; }
        .table-footer-total { background-color: #e9ecef; font-weight: bold; }
        
        @media print {
            .no-print { display: none !important; }
            .card { border: none !important; box-shadow: none !important; }
            body { background-color: white !important; }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">üìä Laporan Pergerakan Stok</h2>
            <div class="no-print">
                <button onclick="window.print()" class="btn btn-outline-dark me-2">üñ®Ô∏è Cetak</button>
                <a href="/merchAdmin.html" class="btn btn-warning">Kembali</a>
            </div>
        </div>

        <div class="card shadow-sm mb-4 no-print">
            <div class="card-body">
                <div class="row align-items-end g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tanggal Awal</label>
                        <input type="date" id="startDate" class="form-control" value="2025-12-01">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tanggal Akhir</label>
                        <input type="date" id="endDate" class="form-control" value="2025-12-17">
                    </div>
                    <div class="col-md-4">
                        <button onclick="loadStockReport()" class="btn btn-primary w-100">Tampilkan Laporan</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="text-center mb-4">
                    <h4 class="mb-1">RINCIAN MUTASI STOK</h4>
                    <p class="text-muted">Periode: <span id="periodText" class="fw-bold">-- s/d --</span></p>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead class="table-header-custom">
                            <tr>
                                <th rowspan="2" style="width: 15%;">ID PRODUK</th>
                                <th rowspan="2">NAMA PRODUK</th>
                                <th colspan="2" class="border-bottom">PERGERAKAN (UNIT)</th>
                                <th rowspan="2" style="width: 15%;">STOK AKHIR</th>
                            </tr>
                            <tr>
                                <th class="text-success">MASUK (+)</th>
                                <th class="text-danger">KELUAR (-)</th>
                            </tr>
                        </thead>
                        <tbody id="reportTbody">
                            </tbody>
                        <tfoot id="reportTfoot" class="table-footer-total">
                            </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadStockReport() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            // Format tampilan periode
            document.getElementById('periodText').innerText = `${start} s/d ${end}`;

            const tbody = document.getElementById('reportTbody');
            const tfoot = document.getElementById('reportTfoot');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Memproses data...</td></tr>';
            tfoot.innerHTML = '';

            try {
                const res = await fetch(`/api/merch/stock-report?startDate=${start}&endDate=${end}`);
                const result = await res.json();

                if (result.success && result.data.length > 0) {
                    let totalIn = 0;
                    let totalOut = 0;
                    let totalStok = 0;

                    tbody.innerHTML = result.data.map(row => {
                        const masuk = parseInt(row.masuk) || 0;
                        const keluar = parseInt(row.keluar) || 0;
                        const stok = parseInt(row.stok_akhir) || 0;

                        totalIn += masuk;
                        totalOut += keluar;
                        totalStok += stok;

                        return `
                            <tr>
                                <td class="text-center fw-bold">${row.product_id}</td>
                                <td>${row.product_name}</td>
                                <td class="text-center text-masuk">${masuk.toLocaleString('id-ID')}</td>
                                <td class="text-center text-keluar">${keluar.toLocaleString('id-ID')}</td>
                                <td class="text-center fw-bold bg-light">${stok.toLocaleString('id-ID')}</td>
                            </tr>
                        `;
                    }).join('');

                    // Menambahkan baris total di tfoot
                    tfoot.innerHTML = `
                        <tr>
                            <td colspan="2" class="text-end py-3">TOTAL PERGERAKAN:</td>
                            <td class="text-center text-success">${totalIn.toLocaleString('id-ID')}</td>
                            <td class="text-center text-danger">${totalOut.toLocaleString('id-ID')}</td>
                            <td class="text-center">${totalStok.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Tidak ada data pergerakan stok pada periode ini.</td></tr>';
                }
            } catch (error) {
                console.error("Gagal load laporan:", error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">Gagal terhubung ke server. Pastikan API tersedia.</td></tr>';
            }
        }

        // Jalankan saat halaman pertama kali dimuat
        document.addEventListener('DOMContentLoaded', loadStockReport);
    </script>
</body>
</html>